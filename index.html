<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="UTF-8">
    <title>Uno</title>
    <link rel="icon" href="images/favicon.png">
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
</head>
<style>

    body {
        background-color: #00a000;
    }

    #top-player {
        position: absolute;
    }

    #left-player {
        position: absolute;
    }

    #right-player {
        position: absolute;
    }

    #bottom-player {
        position: absolute;
    }

    #deck {
        position: absolute;
    }

    #discard {
        position: absolute;
    }

    #uno-button {
        position: absolute;
        display: none;
        padding: 0px;
        border: 1px solid black;
        border-radius: 3px;
        width: 45px;
        height: auto;
    }

    .button {
        position: absolute;
        display: none;
    }

    .message {
        position: absolute;
        display: none;
        text-align: center;
    }

    img {
        position: absolute;
    }

    .card {
        width: 70px;
        height: 105px;
    }

    h1 {
        color: White;
        font-size: 25px;
        margin-top: 10px;
        margin-left: 10px;
    }

    #help-link {
        float: right;
        font-size: 15px;
        padding-top: 10px;
        margin-right: 10px;
    }

    .vl {
        border-left: 1px solid black;
        height: 100%;
        position: absolute;
        left: 50%;
        top: 0;
    }

    .hl {
        position: absolute;
        width: 100%;
        top: 50%;
        padding: 0;
        margin: 0;
    }

</style>
<body>
<!--<hr id="hr" class="hl">-->
<!--<div class="vl"></div>-->
<!--<button id="uno-button" style="width:50px" class="btn btn-danger  btn-sm button">Uno</button>-->

<div>
    <h1>UNO<a href="https://www.unorules.com" id="help-link">Official Rules</a></h1>
</div>

<div id="cards"></div>
<div class="container">

    <div id="top-player"></div>
    <div id="left-player"></div>
    <div id="right-player"></div>
    <div id="bottom-player"></div>

    <div id="deck"></div>
    <div id="discard"></div>

    <button id="deal-button"  class="btn btn-danger btn-lg button">Deal</button>
    <button id="sort-button" style="width:50px" class="btn btn-info btn-sm button">Sort</button>
    <button id="hint-button" style="width:50px" class="btn btn-warning btn-sm button">Hint</button>
    <input type="image" id="uno-button" src="images/UNO-button.png" class="btn btn-default btn-sm button">

    <div id="message-box" style="min-height:52px" class="alert alert-warning message">&nbsp;</div>
</div>

<script>
    function idToImage(card) {
        var image = "images/";
        switch (card[0]) {
            case "b":
                image = image + "blue";
                break;
            case "g":
                image = image + "green";
                break;
            case "r":
                image = image + "red";
                break;
            case "y":
                image = image + "yellow";
                break;
            case "x":
                image = image + "black";
                break;
            default:
                break;
        }
        switch (card[1]) {
            case "s":
                image = image + "_skip";
                break;
            case "p":
                image = image + "_+2";
                break;
            case "r":
                image = image + "_reverse";
                break;
            case "d":
                image = image + "_+4";
                break;
            case "w":
                image = image + "_wildcard";
                break;
            default:
                image = image + "_" + card[1];
                break;
        }
        image = image + ".png";
        return image;
    }

    function clone (src){
        return JSON.parse(JSON.stringify(src));
    }

    //create deck of cards
    var globalEmptyConsequence = {
            pickUp: 0,
            reverse: false,
            skip: false
        };

    function createCard(id) {
        return {
            id: id,
            left: 0,
            top: 0,
            zindex: 0,
            front: idToImage(id),
            back: "images/back.png",
            faceup: false,
            size: 70,
            consequence: clone(globalEmptyConsequence)
        }
    }

    // Create global variables
    var colours = ["b", "g", "r", "y"];
    var special = ["s", "r", "p"];

    function createDeck() {
        var deck = [];
        // insert all coloured cards
        colours.forEach(function (colour) {
            for (var i = 0; i < 10; i++) {
                deck.push(createCard(colour + i));
            }
            special.forEach(function (character) {
                // There are two special cards per colour
                ["0","1"].forEach(function(number){
                    var card = createCard(colour + character + number);
                    switch(character){
                        case "s":
                            card.consequence.skip = true;
                            break;
                        case "r":
                            card.consequence.reverse = true;
                            break;
                        case "p":
                            card.consequence.pickUp = 2;
                            break;
                    }
                    deck.push(card);

                });
            });
        });

        //insert black cards
        // for (var i = 0; i < 4; i++) {
        //     deck.push(createCard ("xd" + i));
        //     deck.push(createCard("xw" + i));
        // }
        return deck;
    }

    // Shuffle an array in place
    function shuffle(a) {
        var j, x, i;
        for (i = a.length - 1; i > 0; i--) {
            j = Math.floor(Math.random() * (i + 1));
            x = a[i];
            a[i] = a[j];
            a[j] = x;
        }
        return a;
    }
    // sort cards in place
    function sortCards(cards) {
        cards.sort(function (item1, item2) {
            if (item1.id < item2.id)
                return -1;
            if (item1.id > item2.id)
                return 1;
            return 0;
        });
    }

    // place all of the cards in the card div before moving them into hands, deck and discard piles
    function layoutCardsOnTable(cards, div) {
        cards.forEach(function (card) {
            var image = card.back;
            var html = '<image style="display:none" class="card" id="' + card.id + '" ' +
                'src="' + image + '" ' +
                'style="left: ' + card.left + 'px; top:' + card.top + 'px"' +
                '></image>';
            $(div).append(html);
        });
    }

    // animation functions
    function showCard(card) {
        $("#" + card.id).show();
        $("#" + card.id).css("z-index", card.zindex);
    }
    function animate(list, delay, callback) {
        if (list.length == 0) {
            callback();
            return;
        }
        var item = list.shift();

        var $el = item.element;
        var card = item.card;
        var css = item.css;

        // turn the card around before animation
        var src = card.faceup ? card.front : card.back;
        if ($("#" + card.id).attr("src") != src) {
            $("#" + card.id).attr('src', src);
        }

        $el.animate(css, delay, function () {
            showCard(card);
            animate(list, delay, callback);
        });
    }
    function moveCards(cards, delay, callback) {
        var animations = [];
        cards.forEach(function (card) {
            var css = {left: card.left + "px", top: card.top + "px", width: card.width, height: "auto"};
            if (delay == 0) {
                var src = card.faceup ? card.front : card.back;
                if ($("#" + card.id).attr("src") != src) {
                    $("#" + card.id).attr('src', src);
                }
                $("#" + card.id).css(css);
                showCard(card);
            } else {
                animations.push({element: $("#" + card.id), card: card, css: css});
            }
        });
        if (delay == 0) {
            callback();
        } else {
            animate(animations, delay, callback);
        }
    }

    // deal number cards out to each player from the deck
    function dealCards(deck, players, number) {
        var cards = [];
        for (var i = 0; i < number; i++) {
            players.forEach(function (player) {
                var card = deck.shift();
                player.hand.push(card);
                cards.push(card);
            });
        }
        return cards;
    }

    // find a card by ID in an array of cards
    function findCard(cards, id) {
        var ret = null;
        cards.forEach(function (card) {
            if (card.id == id) {
                ret = card;
            }
        });
        return ret;
    }

    // remove a card by ID from an arracy of cards
    function removeCard(cards, id) {
        var ret = null;
        for (var i = cards.length - 1; i >= 0; --i) {
            if (cards[i].id == id) {
                ret = cards[i];
                cards.splice(i, 1);
            }
        }
        return ret;
    }

    // find a player by its html div name
    function findPlayer(players, div) {
        var ret = null;
        players.forEach(function (player) {
            if (player.div == div) {
                ret = player;
            }
        });
        return ret;
    }

    // layout cards in a single stack of cards - face up or down
    function layoutCardStack(cards, name, faceup) {
        var div = $(name);
        var position = div.position();
        var offset = 0;
        var zindex = cards.length;

        cards.forEach(function (card) {
            card.left = position.left - offset;
            card.top = position.top - offset;
            card.zindex = zindex;
            card.faceup = faceup;
            card.width = 70;
            zindex--;
            offset -= 2;
            offset = Math.max(-10, offset);
        });
    }
    // layout cards in a hand of cards
    function layoutCardHand(player) {
        var div = $("#" + player.div);
        var position = div.position();

        var offsetLeft = 0;
        var offsetTop = 0;
        var zindex = 0;

        var count = player.hand.length;
        count--; // zero based

        var adjleft = player.offsetLeft * count / 2 + player.width / 2;
        var adjtop = player.offsetTop * count / 2 + player.height / 2;

        if (player.sort) {
            sortCards(player.hand);
        }

        player.hand.forEach(function (card) {
            card.left = position.left + offsetLeft - adjleft;
            card.top = position.top + offsetTop - adjtop;
            card.zindex = zindex;
            card.faceup = player.faceup;
            card.width = player.width;

            // add depth
            zindex++;

            // add offset
            offsetLeft += player.offsetLeft;
            offsetTop += player.offsetTop;
        });
    }

    // check that 2 cards are a valid match and therefore a valid move
    function isValidMove(cardA, cardB) {
        if ((cardA.id[0]) == "x") {
            return true;
        }
        if (colours.indexOf(cardA.id[0]) != -1) {
            // Simple case are the card colour the same
            if (cardA.id[0] == cardB.id[0]) {
                return true;
            }
            // simple case are the card numbers the same
            if (cardA.id[1] == cardB.id[1]) {
                return true;
            }
            return false;
        }
        return false;
    }

    // find a matching pick up number in the hand or return null
    function findMatchingPickUpCard(hand, number){
        var ret = null;
        hand.forEach(function(card){
            if(card.consequence.pickUp == number){
                ret = card;
            }
        });
        return ret;
    }

    // given an object log it's contents to the console
    function logObject(obj){
        console.log(JSON.stringify(obj));
    }

    // return the next play in the players list
    var globalPlayerIndex = -1;
    var globalClockWise = true;
    function getNextPlayer(players){

        if(globalClockWise) {
            globalPlayerIndex++;
        } else {
            globalPlayerIndex--;
        }

        if(globalPlayerIndex > players.length - 1){
            globalPlayerIndex = 0;
        } else if(globalPlayerIndex < 0){
            globalPlayerIndex = players.length - 1;
        }

        return globalPlayerIndex;
    }

    // automated turn handling function
    function playGame(index, consequence, players, discard, deck, callback) {
        var player = players[index];

        var text = " cards: ";
        player.hand.forEach(function(card){
            text += card.id + " ";
        });

        console.log(player.div + " clockwise: " + globalClockWise + " discard: " + discard[0].id + " consiquence: " + JSON.stringify(consequence) + text);


        if (player.div == "bottom-player") {
            callback(consequence);
            return;
        }

        var nextPlayerIndex = getNextPlayer(players);

        //check and apply consequence for skip
        if (consequence.skip){
            console.log(player.div + " skipping go");
            // wait 1 second before moving on
            setTimeout(function() {
                playGame(nextPlayerIndex, clone(globalEmptyConsequence), players, discard, deck, callback);
            }, 500);
            return;
        }

        // check and apply consequence for pick up
        if (consequence.pickUp != 0){
            // look to see if we have a pick up card - if so play it
            var topDeckCard = discard[0];
            var card = findMatchingPickUpCard(player.hand, topDeckCard.consequence.pickUp);
            // if we have a pickUp play it
            if(card != null){
                console.log(player.div + " adding to consequence");

                discardCard(card, player, discard, function (topCard) {
                    var nextConsequence = clone(topCard.consequence);
                    nextConsequence.pickUp += consequence.pickUp;

                    setTimeout(function(){
                        playGame(nextPlayerIndex, nextConsequence, players, discard, deck, callback)
                    }, 500);
                });
            } else {
                console.log(player.div + " picking up " + consequence.pickUp + " cards");
                for(var i = 0; i < consequence.pickUp - 1; i++){
                    selectFromDeck(player, deck, discard, function (){});
                }
                selectFromDeck(player, deck, discard, function () {
                    setTimeout(function(){
                        playGame(nextPlayerIndex, clone(globalEmptyConsequence), players, discard, deck, callback)
                    }, 500);
                });
            }
            return;
        }

        var found = false;
        player.hand.forEach(function (card) {
            if (!found && isValidMove(card, discard[0])) {
                found = true;
                console.log(player.div + " discarding card: " + card.id);
                discardCard(card, player, discard, function (topCard) {

                    // reverse direction
                    if(topCard.consequence.reverse){
                        console.log(player.div + " is changing direction");

                        globalClockWise = !globalClockWise;
                        // next player needs to be reversed pass this one
                        nextPlayerIndex = getNextPlayer(players);
                        nextPlayerIndex = getNextPlayer(players);
                    }

                    setTimeout(function(){
                        playGame(nextPlayerIndex, clone(topCard.consequence), players, discard, deck, callback)
                    }, 500);
                })
            }
        });

        if (!found) {
            selectFromDeck(player, deck, discard, function (card) {
                console.log(player.div + " can't go so selecting from deck card: " + card.id);
                setTimeout(function(){
                    playGame(nextPlayerIndex, clone(globalEmptyConsequence), players, discard, deck, callback)
                }, 500);
            });
        }
    }

    // human player handling function
    function cardClick(event, myConsequence, players, discard, deck) {
        // find ths player
        var player = findPlayer(players, "bottom-player");
        var nextPlayerIndex = getNextPlayer(players);

        // empty the message
        message("");

        function myTurn(nextConsequence) {
            //check and apply consequence
            if (nextConsequence.skip){
                message("Skip a go");

                // wait 1 second before moving on
                setTimeout(function(){
                    playGame(nextPlayerIndex, clone(globalEmptyConsequence), players, discard, deck, myTurn);
                }, 500);
                return;
            }

            message("Your turn");
            $(".card").click(function (event) {
                cardClick(event, nextConsequence, players, discard, deck);
            });
        }

        // read the id from the event - this is the id of the card that has been clicked
        // it could be any card
        var id = event.currentTarget.id;

        // Search player hand to see if selected card is in there
        var card = findCard(player.hand, id);
        if (card != null) {
            if (isValidMove(card, discard[0])) {
                $(".card").unbind("click");

                discardCard(card, player, discard, function (topCard) {
                    // special handling for uno button
                    if(player.hand.length == 1){
                        var clickUnoButton = false;

                        $("#uno-button").click(function () {
                            clickUnoButton = true;
                            message("Uno!");
                            console.log(player.div + " Uno!");

                            playGame(nextPlayerIndex, clone(topCard.consequence), players, discard, deck, myTurn);
                            $("#uno-button").unbind("click");
                        });

                        setTimeout(function(){
                            $("#uno-button").unbind("click");
                            if(clickUnoButton){
                                return;
                            }

                            message("Pick up 2 for not clicking Uno!");

                            console.log(player.div + " picking up 2 cards for not saying uno");
                                // first card
                                selectFromDeck(player, deck, discard, function () {
                                    // second card
                                    selectFromDeck(player, deck, discard, function () {
                                        playGame(nextPlayerIndex, clone(topCard.consequence), players, discard, deck, myTurn);
                                    });
                                });
                        }, 3000);

                    } else {
                        setTimeout(function () {
                            playGame(nextPlayerIndex, clone(topCard.consequence), players, discard, deck, myTurn)
                        }, 500);
                    }
                });
            }
        }

        // look for the card in the deck
        card = findCard(deck, id);
        if (card != null) {
            $(".card").unbind("click");

            selectFromDeck(player, deck, discard, function () {
                setTimeout(function(){
                    playGame(nextPlayerIndex, clone(globalEmptyConsequence), players, discard, deck, myTurn)
                });
            });
        }
    }

    function hint() {
    }

    function calculateCard() {
    }

    // send a message to the message box and cancel it after a period
    // we only want one timer running and we need to be able to cancel it
    // so use a golbal var
    var globalTimer = null;
    function message(text) {
        $("#message-box").html(text);

        if (globalTimer) {
            clearTimeout(globalTimer); //cancel the previous timer.
            globalTimer = null;
        }
        globalTimer = setTimeout(function(){$("#message-box").html("&nbsp")}, 7500);
    }

    // discard a card from the player's hand to the discard pile
    function discardCard(card, player, discard, callback) {
        var selectedCard = removeCard(player.hand, card.id);
        discard.unshift(card);
        $("#" + selectedCard.id).css("z-index", 2000);
        layoutCardStack(discard, "#discard", true);
        layoutCardHand(player);
        moveCards([selectedCard], 500, function () {
            moveCards(player.hand, 50, function () {
                moveCards(discard, 0, function () {
                    callback(card);
                })
            })
        });
    }
    // select a card from the deck into the player's hand
    function selectFromDeck(player, deck, discard, callback) {
        // force card selection to be top of the deck
        var selectedCard = deck.shift();

        // if deck is empty reset it with the discard pile
        if(deck.length == 0){
            var topCard = discard.shift();
            for(var i = 0; i < discard.length; i++) {
                deck.push(discard[i]);
                discard.splice(i, 1);
                i--; //decrement i if we remove an item
            }
            discard.push(topCard);
        }

        player.hand.push(selectedCard);

        layoutCardStack(discard, "#discard", true);
        layoutCardStack(deck, "#deck", false);
        layoutCardHand(player);

        moveCards([selectedCard], 500, function () {
            moveCards(discard, 0, function () {
                moveCards(deck, 0, function () {
                    moveCards(player.hand, 100, function () {
                        callback(selectedCard);
                    })
                })
            })
        });
    }

    // deal out cards to the players from the deck move them into place and animate the move
    function dealOutCards(deck, players, discard) {
        $("#deal-button").hide();
        var cards = dealCards(deck, players, 7);
        players.forEach(function (player) {
            layoutCardHand(player);
        });
        var card = deck.shift();
        card.faceup = true;
        discard.push(card);

        layoutCardStack(discard, "#discard", true);
        layoutCardStack(deck, "#deck", false);

        moveCards(cards, 150, function () {
            moveCards(discard, 150, function () {
                moveCards(deck, 0, function () {

                    // now show the sort, hint and message objects
                    $("#message-box").show();
                    $("#hint-button").show();
                    $("#sort-button").show();
                    $("#uno-button").show();

                    message("Your turn");

                    $(".card").click(function (event) {
                        cardClick(event, clone(globalEmptyConsequence), players, discard, deck);
                    })
                })
            })
        });
    }

    // this is the starting function for jQuery.
    // Its called when everything has initialised and the program can start
    $(document).ready(function () {

        // set-up all of the divs on the screen by calculating the screen size
        // this has to be done as mobile, tablet and PCs all have difference screen dimentions
        var width = $(window).width();
        var height = $(window).height();
        var minTable = 700;

        var maxTableWidth = Math.min(minTable, width);
        var maxTableHeight = Math.min(minTable, height);

        var cardWidth = 70;
        var cardHeight = 105;

        var smallCardWidth = cardWidth;
        var smallCardHeight = cardHeight;

        if (maxTableWidth < minTable) {
            smallCardWidth = 50;
            smallCardHeight = 78;
        }

        var headerOffset = 75;
        var topOffSet = headerOffset + 130;

        var tableHorizontalMiddle = width / 2;
        var tableVerticalMiddle = maxTableHeight / 2;

        $("#top-player").css("left", tableHorizontalMiddle + "px");
        $("#top-player").css("top", headerOffset + "px");

        $("#bottom-player").css("left", tableHorizontalMiddle + "px");
        $("#bottom-player").css("top", maxTableHeight - cardHeight + "px");

        $("#left-player").css("left", (tableHorizontalMiddle - maxTableWidth / 2) + smallCardWidth + "px");
        $("#left-player").css("top", topOffSet + "px");

        $("#right-player").css("left", (tableHorizontalMiddle + maxTableWidth / 2) - smallCardWidth + "px");
        $("#right-player").css("top", topOffSet + "px");

        $("#deck").css("left", tableHorizontalMiddle - cardWidth - 10 + "px");
        $("#deck").css("top", topOffSet - 50 + "px");

        $("#discard").css("left", tableHorizontalMiddle + 10 + "px");
        $("#discard").css("top", topOffSet - 50 + "px");

        $("#hint-button").css("left", tableHorizontalMiddle - 110 + "px");
        $("#hint-button").css("top", maxTableHeight - cardHeight / 3 + "px");

        $("#sort-button").css("left", tableHorizontalMiddle - 25 + "px");
        $("#sort-button").css("top", maxTableHeight - cardHeight / 3 + "px");

        $("#uno-button").css("left", tableHorizontalMiddle + 60 + "px");
        $("#uno-button").css("top", maxTableHeight - cardHeight / 3 + "px");

        var messageWidth = Math.min(maxTableWidth, 300);
        $("#message-box").css("width", messageWidth + "px");
        $("#message-box").css("left", tableHorizontalMiddle - messageWidth / 2 + "px");
        $("#message-box").css("top", maxTableHeight - 2 * cardHeight - 25 + "px");

        $("#deal-button").css("left", tableHorizontalMiddle + 10 + "px");
        $("#deal-button").css("top", topOffSet - 50 + cardHeight / 2 - 10 + "px");

        // create the discard and deck piles
        var discard = [];
        var deck = createDeck();

        // create the players array and creat some players
        var players = [];
        players.push({
            hand: [],
            name: "James",
            div: "left-player",
            offsetTop: 20,/*15,*/
            offsetLeft: 0,
            faceup: true,/*false,*/
            width: smallCardWidth,
            height: smallCardHeight,
            sort: false
        });
        players.push({
            hand: [],
            name: "Sam",
            div: "top-player",
            offsetTop: 0,
            offsetLeft: 20,/*15,*/
            faceup: true,/*false,*/
            width: smallCardWidth,
            height: smallCardHeight,
            sort: false
        });
        players.push({
            hand: [],
            name: "Emily",
            div: "right-player",
            offsetTop: 20,/*15,*/
            offsetLeft: 0,
            faceup: true,/*false,*/
            width: smallCardWidth,
            height: smallCardHeight,
            sort: false
        });
        players.push({
            hand: [],
            name: "Barney",
            div: "bottom-player",
            offsetTop: 0,
            offsetLeft: 25,
            faceup: true,
            width: cardWidth,
            height: cardHeight,
            sort: false
        });

        // put the cards initially in their own div area
        layoutCardsOnTable(deck, "#cards");
        // randomly shuffle the deck
        deck = shuffle(deck);
        // layout the cards into the deck
        layoutCardStack(deck, "#deck", false);
        // move them into the deck on the table
        moveCards(deck, 0, function () {});

        // show the deal button so it can be clicked
        $("#deal-button").show();

        // setup the function so that when the player clicks the deal-button it deals out the cards
        $("#deal-button").click(function () {
            dealOutCards(deck, players, discard)
        });

        // setup the function so that when the player clicks the hint button it provides a hint
        $("#hint-button").click(function () {
            message("Try match the colour and number of your cards with the card on the discard pile.");
        });

        // set-up the function so that when the play clicks the sort button their hand is sorted
        $("#sort-button").click(function () {
            var player = findPlayer(players, "bottom-player");
            player.sort = true;
            layoutCardHand(player);
            moveCards(player.hand, 250, function () {
            });
        });

        // for(var i = 0; i < 10; i++) {
        //     console.log(getNextPlayer(players));
        // }
        //
        // console.log("reverse");
        // globalClockWise = !globalClockWise;
        //
        // for(var i = 0; i < 11; i++) {
        //     console.log(getNextPlayer(players));
        // }
        //
        // console.log("reverse");
        // globalClockWise = !globalClockWise;
        //
        // for(var i = 0; i < 10; i++) {
        //     console.log(getNextPlayer(players));
        // }

    })

</script>
</body>
</html>