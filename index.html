<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="UTF-8">
    <title>Uno</title>
    <link rel="icon" href="images/favicon.png">
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
</head>
<style>

    body {
        background-color: #00a000;
    }

    #top-player {
        position: absolute;
    }

    #left-player{
        position: absolute;
    }

    #right-player {
        position: absolute;
    }

    #bottom-player {
        position: absolute;
    }

    #deck {
        position: absolute;
    }

    #discard {
        position: absolute;
    }

    #deal-button {
        position: absolute;
        display: none;
    }

    img {
        position: absolute;
    }

    .card {
        width: 70px;
        height: 105px;
    }

    h1 {
        color:White;
        font-size: 30px;
    }

    .page-header {
        margin: 20px 0 20px;
        padding-bottom: 0px;
    }

    #help-link {
        float: right;
        font-size:15px;
        align: middle;
    }

    .vline {
        position: absolute;
        background-color: black;
        width: 1px;
        height: 100%;
        left: 50%;
        top: 0%;
    }

    .hline {
        position: absolute;
        width: 1px;
        height: 100%;
        left: 50%;
        top: 0;
        background-color: black;
        transform: rotate(90deg);
    }

</style>
<body>
<div>
    <h1>UNO Card Game</h1>
    <a href= "https://www.unorules.com" id="help-link">Official Rules</a>
</div>

<div id="cards"></div>
<div class="container">

    <div id="top-player"></div>
    <div id="left-player"></div>
    <div id="right-player"></div>
    <div id="bottom-player"></div>

    <div id="deck"></div>
    <div id="discard"></div>

    <div id="deal-button">
        <button class="btn btn-danger btn-lg">Deal</button>
    </div>
</div>

<script>
    function idToImage(card){
        var image = "images/";
        switch(card[0]){
            case "b":
                image = image +"blue";
                break;
            case "g":
                image = image +"green";
                break;
            case "r":
                image = image +"red";
                break;
            case "y":
                image = image +"yellow";
                break;
            case "x":
                image = image +"black";
                break;
            default:
                break;
        }
        switch(card[1]){
            case "s":
                image = image + "_skip";
                break;
            case "p":
                image = image + "_+2";
                break;
            case "r":
                image = image + "_reverse";
                break;
            case "d":
                image = image + "_+4";
                break;
            case "w":
                image = image + "_wildcard";
                break;
            default:
                image = image + "_" + card[1];
                break;
        }
        image = image + ".png";
        return image;
    }

    //create deck of cards
    function createCard (id) {
        return {id: id,
            left:0,
            top:0,
            zindex: 0,
            front: idToImage(id),
            back: "images/back.png",
            faceup: false
        }
    }

    // Create global variables
    var colours = ["b", "g", "r", "y"];
    var special = ["s","r","p"];

    function createDeck() {
        var deck = [];
        // insert all coloured cards
        colours.forEach(function (colour) {
            for (var i = 0; i < 10; i++) {
                deck.push(createCard(colour + i));
            }
            special.forEach(function (character) {
                // There are two special cards per colour
                deck.push(createCard(colour + character + "0"));
                deck.push(createCard(colour + character + "1"));
            });
        });
        //insert black cards
        // for (var i = 0; i < 4; i++) {
        //     deck.push(createCard ("xd" + i));
        //     deck.push(createCard("xw" + i));
        // }
        return deck;
    }

    // Shuffle array in place
    function shuffle(a) {
        var j, x, i;
        for (i = a.length - 1; i > 0; i--) {
            j = Math.floor(Math.random() * (i + 1));
            x = a[i];
            a[i] = a[j];
            a[j] = x;
        }
        return a;
    }

    function printCards(cards, div) {
        cards.forEach(function (card) {
            var image = card.back;
            var html = '<image style="display:none" class="card" id="' + card.id + '" ' +
                'src="' + image + '" ' +
                'style="left: ' + card.left + 'px; top:' + card.top + 'px"' +
                '></image>';
            $(div).append(html);
        });
    }

    function showCards(cards){
        cards.forEach(function(card){
            $("#" + card.id).show();
        })
    }

    function hideCards(cards){
        cards.forEach(function(card){
            $("#" + card.id).hide();
        })
    }

    function showCard (card){
        $("#" + card.id).show();
        $("#" + card.id).css("z-index", card.zindex);
        /*
        var src = card.faceup ? card.front : card.back;
        if($("#" + card.id).attr("src") != src) {
            $("#" + card.id).fadeOut(function () {
                $(this).attr('src', src).fadeIn();
            });
        };
        */
    }

    function animate (list,delay, callback){
        if (list.length == 0){
            callback();
            return;
        }
        var item = list.shift();

        var $el = item.element;
        var card = item.card;
        var css = item.css;

        // turn the card around before animation
        var src = card.faceup ? card.front : card.back;
        if($("#" + card.id).attr("src") != src) {
            $("#" + card.id).attr('src', src);
        };

        $el.animate(css, delay, function(){
            showCard(card);
            animate(list, delay, callback);
        });
    }

    function moveCards(cards, delay, callback) {
        var animations = [];
        cards.forEach(function(card){
            var css = {left: card.left + "px", top: card.top + "px", width: card.size, height: "auto"};
            if (delay == 0){
                $("#" + card.id).css(css);
                showCard(card);
            } else {
                animations.push({element: $("#" + card.id), card: card, css: css});
            }
        });
        if (delay == 0){
            callback();
        } else{
            animate(animations, delay, callback);
        }
    }

    function dealCards(deck, players, number){
        var cards = [];
        for(var i = 0; i < number; i++){
            players.forEach(function(player){
                var card = deck.shift();
                player.hand.push(card);
                cards.push(card);
            });
        }
        return cards;
    }

    function findCard(cards, id){
        var ret = null;
        cards.forEach(function(card){
            if (card.id == id){
                ret = card;
            }
        });
        return ret;
    }

    function findPlayer(players, div){
        var ret = null;
        players.forEach(function(player){
            if (player.div == div){
                ret = player;
            }
        });
        return ret;
    }

    function removeCard (cards, id){
        var ret = null;
        for (var i = cards.length - 1; i >= 0; --i) {
            if (cards[i].id == id) {
                ret = cards[i];
                cards.splice(i,1);
            }
        }
        return ret;
    }

    function layoutCardStack(cards, name, faceup){
        var div = $(name);
        var position = div.position();
        var offset = 0;
        var zindex = cards.length;
        cards.forEach(function(card){
            card.left = position.left - offset;
            card.top = position.top - offset;
            card.zindex = zindex;
            card.faceup = faceup;
            card.size = 70;
            zindex--;
            offset-= 2;
            offset = Math.max(-10, offset);
        });
    }

    function layoutCardHand(player){
        var div = $("#" + player.div);
        var position = div.position();
        var offsetLeft = 0;
        var offsetTop = 0;
        var zindex = 0;
        var count = player.hand.length;
        var adjleft = player.offsetLeft*count/2;
        var adjtop = player.offsetTop*count/2;
        player.hand.forEach(function(card){
            card.left = position.left + offsetLeft - adjleft;
            card.top = position.top + offsetTop - adjtop;
            card.zindex = zindex;
            card.faceup = player.faceup;
            card.size = player.size;
            zindex++;
            offsetLeft += player.offsetLeft;
            offsetTop += player.offsetTop;
        });
    }

    function isValidMove(cardA, cardB){
        if ((cardA.id[0]) == "x"){
            return true;
        }
        if (colours.indexOf(cardA.id[0]) != -1){
            // Simple case are the card colour the same
            if(cardA.id[0] == cardB.id[0]){
                return true;
            }
            // simple case are the card numbers the same
            if(cardA.id[1] == cardB.id[1]){
                return true;
            }
            return false;
        }
        return false;
    }

    function playGame(index, players, discard, deck, callback){
        var player = players[index];

        if (player.div == "bottom-player"){
            callback();
            return;
        }

        var found = false;
        player.hand.forEach(function(card){
            if(!found && isValidMove(card, discard[0])){
                found = true;
                discardCard(card, player, discard, function(){
                    playGame(index + 1, players, discard, deck, callback)
                })
            }
        });

        if(!found){
            selectFromDeck(player, deck, function(){
                playGame(index + 1, players, discard, deck, callback)
            });
        }
    }

    function discardCard (card, player, discard, callback){
        var selectedCard = removeCard(player.hand, card.id);  //player.hand.shift();
        discard.unshift(card);
        $("#" + selectedCard.id).css("z-index", 2000);
        layoutCardStack(discard, "#discard", true);
        layoutCardHand(player);
        moveCards([selectedCard], 500, function (){
            moveCards(player.hand, 50, function(){
                moveCards(discard, 0, function(){
                    callback();
                })
            })
        });
    }

    function selectFromDeck (player ,deck, callback){
        // force card selection to be top of the deck
        var selectedCard = deck.shift();
        player.hand.push(selectedCard);
        layoutCardStack(deck, "#deck", false);
        layoutCardHand(player);
        moveCards([selectedCard], 250, function (){
            moveCards (player.hand, 50, function() {
                moveCards(deck, 0, function () {
                    callback();
                })
            })
        })
    }

    function cardClick (event, players, discard, deck){
        $(".card").unbind("click");
        var id = event.currentTarget.id;
        // Search the bottom player hand to see if selected card is in there
        var player = findPlayer(players,"bottom-player");
        var card = findCard(player.hand, id);
        // if card found: then action, player select
        if(card != null) {
            if(isValidMove(card, discard[0])) {
                discardCard(card, player, discard, function () {
                    playGame(0, players, discard, deck, function(){
                        $(".card").click(function (event) {
                            cardClick(event, players, discard, deck);
                        });
                    })
                });
            } else {
                $(".card").click(function (event) {
                    cardClick(event, players, discard, deck);
                });
            }
            return;
        }
        // search the deck to see  if its in there
        card = findCard(deck, id);
        if (card != null){
            selectFromDeck(player, deck, function(){
                $(".card").click(function(event){
                    cardClick(event, players, discard, deck);
                });
            });
            return;
        }
    }

    $(document).ready(function(){
        var width = $(window).width();
        var height = $(window).height();

        var tableWidth = Math.min(700, width);
        var tableHeight = Math.min(700, height);

        var cardWidth = 70;
        var cardHeight = 105;

        var headerOffset = 133;

        $("#top-player").css("left", width/2 - cardWidth/2 + "px");
        $("#bottom-player").css("left", width/2 - cardWidth/2 + "px");
        $("#left-player").css("left", (width/2 - tableWidth/2) + 20 + "px");
        $("#right-player").css("left", (width/2 + tableWidth/2) - cardWidth + "px");

        $("#deck").css("left", width/2 - cardWidth - 10 + "px");
        $("#discard").css("left", width/2 + 10 + "px");
        $("#deal-button").css("left", width/2 + cardWidth/2  + "px");

        $("#top-player").css("top", headerOffset + 20 + "px");
        $("#bottom-player").css("top", tableHeight - cardHeight + "px");
        $("#left-player").css("top", tableHeight/2 + "px");
        $("#right-player").css("top", tableHeight/2 + "px");

        $("#deck").css("top", tableHeight/2 + "px");
        $("#discard").css("top", tableHeight/2 + "px");
        $("#deal-button").css("top", tableHeight/2 + cardHeight/4+ "px");

        var discard = [];
        var deck = createDeck();
        var players = [];

        players.push({hand:[], name:"James", div: "left-player", offsetTop: 15, offsetLeft: 0, faceup: false, size: 50});
        players.push({hand:[], name:"Sam", div: "top-player", offsetTop: 0, offsetLeft: 15, faceup: false, size: 50});
        players.push({hand:[], name:"Emily", div: "right-player", offsetTop: 15, offsetLeft: 0, faceup: false, size: 50});
        players.push({hand:[], name:"Barney", div: "bottom-player", offsetTop: 0, offsetLeft: 25, faceup: true, size: 70});

        // put the cards initially in their own div area
        printCards(deck, "#cards");

        deck = shuffle(deck);
        layoutCardStack( deck, "#deck", false);
        moveCards(deck, 0, function(){});

        $("#deal-button").show();
        $("#deal-button").click(function(){
            $("#deal-button").hide();
            var cards = dealCards(deck, players, 7);
            players.forEach(function(player){
                layoutCardHand(player);
            });
            var card = deck.shift();
            card.faceup = true;
            discard.push(card);
            layoutCardStack(discard, "#discard", true);
            layoutCardStack(deck, "#deck", false);
            moveCards(cards, 250, function (){
                moveCards(discard, 250, function(){
                    moveCards(deck, 0, function (){
                        $(".card").click(function(event){
                            cardClick(event, players, discard, deck);
                        })
                    })
                })
            });
        });
    });
</script>
</body>
</html>