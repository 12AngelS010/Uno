<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="UTF-8">
    <title>Uno</title>
    <link rel="icon" href="images/favicon.png">
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
</head>
<style>

    body {
        background-color: #00a000;
    }

    #top-player {
        position: absolute;
    }

    #left-player {
        position: absolute;
    }

    #right-player {
        position: absolute;
    }

    #bottom-player {
        position: absolute;
    }

    #deck {
        position: absolute;
    }

    #discard {
        position: absolute;
    }

    #uno-button {
        position: absolute;
        display: none;
        padding: 0px;
        border: 1px solid black;
        border-radius: 3px;
        width: 45px;
        height: auto;
    }

    .button {
        position: absolute;
        display: none;
    }

    .message {
        position: absolute;
        display: none;
        text-align: center;
        z-index: -100;
        max-height: 50px;
        min-height: 50px;
        height: 50px;
        margin: 0px;
    }

    img {
        position: absolute;
    }

    .card {
        width: 70px;
        height: 105px;
    }

    h1 {
        color: White;
        font-size: 25px;
        margin-top: 10px;
        margin-bottom: 0px;
        margin-left: 10px;
    }

    #help-link {
        float: right;
        font-size: 15px;
        padding-top: 10px;
        margin-right: 10px;
    }

    .vl {
        border-left: 1px solid black;
        height: 100%;
        position: absolute;
        left: 50%;
        top: 0;
    }

    .hl {
        position: absolute;
        width: 100%;
        top: 50%;
        padding: 0;
        margin: 0;
    }

    .box {
        position: absolute;
        width: 25px;
        height: 25px;
        margin: 0px;
        border: 1px solid darkslategrey;
    }

    .blue {
        background: #4a4cff;
    }

    .red {
        background: #ff4a4b;
    }

    .green {
        background: #4ba04b;
    }

    .yellow {
        background: #ffa002;
    }

    .black {
        background: #000000;
    }

</style>
<body>
<!--<hr id="hr" class="hl">-->
<!--<div class="vl"></div>-->
<!--<button id="uno-button" style="width:50px" class="btn btn-danger  btn-sm button">Uno</button>-->
<div id="container" class="container">

    <h1 id="uno-heading">UNO<a href="https://www.unorules.com" id="help-link">Official Rules</a></h1>

    <div id="cards"></div>

    <div id="card-colour" class="box" style="display: none"></div>

    <div id="colour-choice" style="display: none">
        <div id="red-box" class="red box"></div>
        <div id="green-box" class="green box"></div>
        <div id="blue-box" class="blue box"></div>
        <div id="yellow-box" class="yellow box"></div>
    </div>

    <div id="top-player"></div>
    <div id="left-player"></div>
    <div id="right-player"></div>
    <div id="bottom-player"></div>

    <div id="deck"></div>
    <div id="discard"></div>

    <button id="deal-button"  class="btn btn-danger btn-lg button">Deal</button>
    <button id="reset-button"  class="btn btn-danger btn-lg button">Restart</button>
    <button id="sort-button" style="width:50px" class="btn btn-info button">Sort</button>
    <button id="hint-button" style="width:50px" class="btn btn-warning button">Hint</button>
    <input type="image" id="uno-button" src="images/UNO-button.png" class="btn btn-default button">

    <div id="message-box" style="min-height:50px" style="display: none" class="alert alert-warning message">&nbsp;</div>
</div>

<script>
    function idToImage(card) {
        var image = "images/";
        switch (card[0]) {
            case "b":
                image = image + "blue";
                break;
            case "g":
                image = image + "green";
                break;
            case "r":
                image = image + "red";
                break;
            case "y":
                image = image + "yellow";
                break;
            case "z":
                image = image + "black";
                break;
            default:
                break;
        }
        switch (card[1]) {
            case "s":
                image = image + "_skip";
                break;
            case "p":
                image = image + "_+2";
                break;
            case "r":
                image = image + "_reverse";
                break;
            case "d":
                image = image + "_+4";
                break;
            case "w":
                image = image + "_wildcard";
                break;
            default:
                image = image + "_" + card[1];
                break;
        }
        image = image + ".png";
        return image;
    }

    function clone (src){
        return JSON.parse(JSON.stringify(src));
    }

    //create deck of cards
    var globalEmptyConsequence = {
            pickUp: 0,
            reverse: false,
            skip: false,
            pickColour: false
        };

    function createCard(id) {
        return {
            id: id,
            left: 0,
            top: 0,
            zindex: 0,
            rotate: 0,
            currentRotate: 0,
            front: idToImage(id),
            back: "images/back.png",
            faceup: false,
            size: 70,
            highlight: false,
            colour: "",
            score: 0,
            consequence: clone(globalEmptyConsequence)
        }
    }

    // Create global variables
    var colours = ["b", "g", "r", "y"];
    var special = ["s", "r", "p"];
    var blackCards = ["d", "w"];

    function createDeck() {
        var deck = [];
        // insert all coloured cards
        colours.forEach(function (colour) {
            for (var i = 0; i < 10; i++) {
                var card = createCard(colour + i);
                card.colour = colour;
                card.score = i;
                deck.push(card);
            }
            special.forEach(function (character) {
                // There are two special cards per colour
                for(var number = 0; number < 2; number++){
                    var card = createCard(colour + character + number);
                    card.colour = colour;
                    card.score = 20;
                    switch(character){
                        case "s":
                            card.consequence.skip = true;
                            break;
                        case "r":
                            card.consequence.reverse = true;
                            break;
                        case "p":
                            card.consequence.pickUp = 2;
                            break;
                    }
                    deck.push(card);
                }
            });
        });

        // insert black cards
        var colour = "z";
        blackCards.forEach(function(character) {
            for(var number = 0; number < 4; number++){
                var card = createCard(colour + character + number);
                card.score = 50;
                switch(character){
                    case "w":
                        card.consequence.pickColour = true;
                        break;
                    case "d":
                        card.consequence.pickUp = 4;
                        card.consequence.pickColour = true;
                        break;
                }
                deck.push(card);
            }
        });
        return deck;
    }

    // Shuffle an array in place
    function shuffleCards(cards) {
        var j, x, i;
        for (i = cards.length - 1; i > 0; i--) {
            j = Math.floor(Math.random() * (i + 1));
            x = cards[i];
            cards[i] = cards[j];
            cards[j] = x;
        }
        return cards;
    }
    // sort cards in place
    function sortCards(cards) {
        cards.sort(function (item1, item2) {
            if (item1.id < item2.id)
                return -1;
            if (item1.id > item2.id)
                return 1;
            return 0;
        });
        return cards;
    }
    // find a card by ID in an array of cards
    function findCard(cards, id) {
        var ret = null;
        cards.forEach(function (card) {
            if (card.id == id) {
                ret = card;
            }
        });
        return ret;
    }
    // remove a card by ID from an arracy of cards
    function removeCard(cards, id) {
        var ret = null;
        for (var i = cards.length - 1; i >= 0; --i) {
            if (cards[i].id == id) {
                ret = cards[i];
                cards.splice(i, 1);
            }
        }
        return ret;
    }

    // place all of the cards in the card div before moving them into hands, deck and discard piles
    function layoutCardsOnTable(cards, div) {
        cards.forEach(function (card) {
            var image = card.back;
            var html = '<image style="display:none" class="card" id="' + card.id + '" ' +
                'src="' + image + '" ' +
                'style="left: ' + card.left + 'px; top:' + card.top + 'px"' +
                '></image>';
            $(div).append(html);
        });
    }

    // animation functions
    function showCard(card) {
        $("#" + card.id).show();
        $("#" + card.id).css("z-index", card.zindex);
    }
    function animate(list, delay, callback) {
        if (list.length == 0) {
            callback();
            return;
        }
        var item = list.shift();

        var $el = item.element;
        var card = item.card;
        var css = item.css;

        var rotate = card.rotate;
        // if(card.rotate == card.currentRotate){
        //     rotate = card.rotate;
        // } else if(card.rotate == 90 && card.currentRotate == 0){
        //     rotate = 3 * 90;
        // } else if(card.rotate == 0 && card.currentRotate == 90){
        //     rotate = 3 * 90;
        // }
        //
        // card.currentRotate = card.rotate;

        // turn the card around before animation
        var src = card.faceup ? card.front : card.back;
        if ($("#" + card.id).attr("src") != src) {
            $("#" + card.id).attr('src', src);
        }

        $el.animate(
            { deg: rotate },
            {
                duration: delay/2,
                step: function(now) {
                    $(this).css({ transform: 'rotate(' + now + 'deg)' });
                }
            }
        );

        $el.animate(css, delay, function () {
            showCard(card);
            animate(list, delay, callback);
        });
    }
    function moveCards(cards, delay, callback) {
        var animations = [];
        cards.forEach(function (card) {
            var css = {left: card.left + "px", top: card.top + "px", width: card.width, height: "auto"};
            if (delay == 0) {
                var src = card.faceup ? card.front : card.back;
                if ($("#" + card.id).attr("src") != src) {
                    $("#" + card.id).attr('src', src);
                }
                $("#" + card.id).css(css);
                showCard(card);
            } else {
                animations.push({element: $("#" + card.id), card: card, css: css});
            }
        });
        if (delay == 0) {
            callback();
        } else {
            animate(animations, delay, callback);
        }
    }

    // deal number cards out to each player from the deck
    function dealCards(deck, players, number) {
        var cards = [];
        for (var i = 0; i < number; i++) {
            players.forEach(function (player) {
                var card = deck.shift();
                player.hand.push(card);
                cards.push(card);
            });
        }
        return cards;
    }

    // find a player by its html div name
    function findPlayer(players, div) {
        var ret = null;
        players.forEach(function (player) {
            if (player.div == div) {
                ret = player;
            }
        });
        return ret;
    }

    // layout cards in a single stack of cards - face up or down
    function layoutStack(cards, name, faceup) {
        var div = $(name);
        var position = div.position();
        var offset = 0;
        var zindex = cards.length;

        cards.forEach(function (card) {
            card.left = position.left - offset;
            card.top = position.top - offset;
            card.zindex = zindex;
            card.faceup = faceup;
            card.width = 70;
            card.rotate = 0;
            zindex--;
            offset -= 2;
            offset = Math.max(-10, offset);
        });
    }
    // layout cards in a hand of cards
    var globalHighlightOffset = 20;
    function layoutHand(player) {
        var div = $("#" + player.div);
        var position = div.position();

        var offsetLeft = 0;
        var offsetTop = 0;
        var zindex = 0;

        var count = player.hand.length;
        count--; // zero based

        var adjleft = player.offsetLeft * count / 2 + player.width / 2;
        var adjtop = player.offsetTop * count / 2;// + player.height / 2;

        if (player.sort) {
            sortCards(player.hand);
        }

        player.hand.forEach(function (card) {
            card.left = position.left + offsetLeft - adjleft;
            card.top = position.top + offsetTop - adjtop;
            // if highlighting a card make it stand out
            if(card.highlight){
                card.top -= globalHighlightOffset;
            }
            card.zindex = zindex;
            card.faceup = player.faceup;
            card.width = player.width;
            card.rotate = player.rotate;

            // add depth
            zindex++;

            // add offset
            offsetLeft += player.offsetLeft;
            offsetTop += player.offsetTop;
        });
    }

    // check that 2 cards are a valid match and therefore a valid move
    function isValidMove(cardFromHand, topOfDiscard, consequence) {

        // work out if we have a current pick up consequence
        if(consequence.pickUp > 0){
            // return true if they are the same pickUp number (otherwise false)
            return (cardFromHand.consequence.pickUp == topOfDiscard.consequence.pickUp)
        }

        // check if its player is playing a black card, always return true
        if ((cardFromHand.id[0]) == "z") {
            return true;
        }

        // check if player is playing to a black onto a black card
        // if they are they must have the correct colour
        if(topOfDiscard.id[0] == "z"){
            return ( cardFromHand.colour == topOfDiscard.colour ) || (topOfDiscard.colour == "");
        }

        // check if its a plan coloured card
        if (colours.indexOf(cardFromHand.id[0]) != -1) {

            // Simple case are the card colours the same
            if (cardFromHand.id[0] == topOfDiscard.id[0]) {
                return true;
            }

            // simple case are the card numbers the same
            if (cardFromHand.id[1] == topOfDiscard.id[1]) {
                return true;
            }

            return false;
        }
        return false;
    }

    // find a matching pick up number in the hand or return null
    function findMatchingPickUpCard(hand, number){
        var ret = null;
        hand.forEach(function(card){
            if(card.consequence.pickUp == number){
                ret = card;
            }
        });
        return ret;
    }

    // given an object log it's contents to the console
    function logObject(obj){
        console.log(JSON.stringify(obj));
    }

    // return the next play in the players list
    var globalPlayerIndex = 0;
    var globalClockWise = true;
    function getNextPlayerIndex(players){

        if(globalClockWise) {
            globalPlayerIndex++;
        } else {
            globalPlayerIndex--;
        }

        if(globalPlayerIndex > players.length - 1){
            globalPlayerIndex = 0;
        } else if(globalPlayerIndex < 0){
            globalPlayerIndex = players.length - 1;
        }

        return globalPlayerIndex;
    }

    function findAllValidCards(cards, topDiscardCard, consequence){
        var ret = [];
        cards.forEach(function(card){
            if(isValidMove(card, topDiscardCard, consequence)){
                ret.push(card);
            }
        });

        return ret;
    }

    // find highest count colour - funciton taken from stack overflow
    function highestCount(obj){
        return Object.keys(obj).reduce(function(a, b){ return obj[a] > obj[b] ? a : b });
    }

    function bot(player, game, consequence){
        function success(card, player, game, consequence){
            nextTurn(player, game, consequence);
        }

        function fail(card, player, game, consequence){
            message("Error!");
        }

        // always call uno
        function uno(callback){
            message("Uno!");
            callback(true);
        }

        // if we pick up a card and can play then always play it
        function playPickupCard(callback){
            callback(true);
        }

        function pickColour(card, player, game, consequence, callback){
            var colour = "y"; // default

            var count = {r:0, g:0, b:0, y:0, x:-1};
            player.hand.forEach(function(card){
                switch(card.colour){
                    case "r":
                        count.r++;
                        break;
                    case "g":
                        count.g++;
                        break;
                    case "b":
                        count.b++;
                        break;
                    case "y":
                        count.y++;
                        break;
                    default:
                        break;
                }
            });

            colour = highestCount(count);
            callback(colour);
        }

        var validCards = findAllValidCards(player.hand, game.discard[0], consequence);
        if(validCards.length){
            playerDiscardCard(validCards[0], player, game, consequence, success, fail, uno, pickColour);
        } else {
            playerPickupCard(player, game, consequence, success, playPickupCard, uno, pickColour);
        }
    }

    var globalBetweenMovesTime = 500;
    var globalYourTurnMessage = "Your turn!";
    function nextTurn(player, game, consequence){

        // check to see if we have a winner
        if(player.hand.length == 0){
            globalMessageShowTime = 0;
            var total = 0;
            game.players.forEach(function(player){
                var score = calculateScore(player.hand);
                total += score;
                console.log(player.name + " has a hand score of " + score);
                console.log(player.name + " has a total score of " + player.score);
            });
            player.score += total;
            var has = "has";
            if(player.name == "You"){
                has = "have";
            }
            message(player.name + " " + has + " won! Total points = " + player.score);
            $("#reset-button").show();

            return;
        }

        // otherwise carry on
        var nextPlayerIndex = getNextPlayerIndex(game.players);
        var player = game.players[nextPlayerIndex];

        setTimeout(function(){
            if(player.human) {
                message(globalYourTurnMessage);
                setUpClickHandlers(game, consequence);
            } else {
                bot(player, game, consequence);
            }
        }, globalBetweenMovesTime);
    }

    // User has to click uno button
    function unoCallback(callback){

        var interval = null;
        var timeout = null;
        var time = 3;// seconds

        // user has seconds to click the uno button
        timeout = setTimeout(function() {
            $("#uno-button").unbind("click");
            clearTimeout(timeout);
            clearInterval(interval);

            callback(false);
        }, time * 1000);

        // give a 1 second count down timer
        var i = time;
        message(" " + i--);
        interval = setInterval(function () {
            message(" " + i--);
        }, 1000);

        $("#uno-button").click(function () {
            $("#uno-button").unbind("click");

            clearTimeout(timeout);
            clearInterval(interval);

            message("Uno!");
            console.log("Uno!");

            callback(true);
        });
    }

    function pickColourCallback(card, player, game, consequence, callback){
        $("#colour-choice").show();

        $(".box").click(function(event){
            $(".box").unbind("click");
            $("#colour-choice").hide();

            var id = event.currentTarget.id;
            switch(id){
                case "red-box":
                    callback("r");
                    break;
                case "green-box":
                    callback("g");
                    break;
                case "blue-box":
                    callback("b");
                    break;
                case "yellow-box":
                    callback("y");
                    break;
                default:
                    callback("y");
                    break;
            }
        });

        // ignore colour pick and put the card back
        function ignore() {
            $(".box").unbind("click");
            $("#colour-choice").hide();
            $(".card").unbind("click");

            layoutHand(player);
            moveCards(player.hand, globalHandSortTime, function () {
                setUpClickHandlers(game, consequence);
            });
        }

        player.hand.forEach(function(card){
            $("#" + card.id).click(ignore);
        });

    }

    function handleHandClickEvent(card, player, game, consequence){
        console.log("Clicked " + card.id + " in players hand");

        console.log("Unbinding all clicks");
        $(".card").unbind("click");
        $("#hint-button").unbind("click");

        function success(card, player, game, consequence){
            nextTurn(player, game, consequence);
        }

        function fail(card, player, game, consequence){
            setUpClickHandlers(game, consequence);
            if(consequence.pickUp > 0){
                var validCards = findAllValidCards(player.hand, game.discard[0], consequence);
                if(validCards.length == 0){
                    message("You have to pick up!");
                }
            } else {
                message("Card can not be discarded!");
            }
        }

        playerDiscardCard(card, player, game, consequence, success, fail, unoCallback, pickColourCallback);
    }
    function playerDiscardCard(card, player, game, consequence, success, fail, uno, pickColour){
        // check if the given card can be discarded onto the top of the discard pile
        if(!isValidMove(card, game.discard[0], consequence)){
            console.log("Not a valid move " + card.id + " can not be placed on " + game.discard[0].id + " with consequence " + JSON.stringify(consequence));
            // failed not valid
            fail(card, player, game, consequence);
        } else {
            console.log("Valid move " + card.id + " placed on " + game.discard[0].id + " with consequence " + JSON.stringify(consequence));
            // discard card and pass the success callback
            discardCard(card, player, game, consequence, success, uno, pickColour);
        }
    }

    function handleDeckClickEvent(card, player, game, consequence){
        console.log("Clicked " + card.id + " in deck");

        console.log("Unbinding all clicks");
        $(".card").unbind("click");
        $("#hint-button").unbind("click");

        function success(card, player, game, consequence){
            nextTurn(player, game, consequence);
        }

        // if we pick up a card and can play it allow the human to choose
        function playPickupCard(callback){
            message("Click card if you want to discard, otherwise click your hand");
            function selectDiscard(){
                $(".card").unbind("click");
                callback(true);
            }
            function selectKeep(){
                $(".card").unbind("click");
                callback(false);
            }

            game.discard.forEach(function(card){
                $("#" + card.id).click(selectDiscard);
            });

            // temporarily pull out the card
            var temp = removeCard(player.hand, card.id);
            $("#" + temp.id).click(selectDiscard);

            player.hand.forEach(function(card){
                $("#" + card.id).click(selectKeep);
            });

            player.hand.push(temp);
        }

        playerPickupCard(player, game, consequence, success, playPickupCard, unoCallback, pickColourCallback);
    }
    function playerPickupCard(player, game, consequence, success, playCard, uno, pickColour){
        // pick up a card
        selectCardFromDeck(player, game, consequence, success, playCard, uno, pickColour);
    }

    var globalHintHighlightTime = 2000;
    function hint(player, game, consequence) {
        var cards = findAllValidCards(player.hand, game.discard[0], consequence);

        // highlight the cards
        cards.forEach(function(card){
           card.highlight = true;
        });

        if(!cards.length){
            message("There are no valid cards to play.");
            return;
        }

        message("Here are all the valid cards.");

        // layout the cards with the highlight hints
        layoutHand(player);
        // move them instantly
        moveCards(cards, 50, function () {
            // set a timeout of 2 seconds and reset the highlight
            setTimeout(function(){
                // highlight the cards
                cards.forEach(function(card){
                    card.highlight = false;
                });
                layoutHand(player);
                moveCards(cards, 50, function (){});
            }, globalHintHighlightTime)
        });
    }
    function calculateCard() {
    }

    // send a message to the message box and cancel it after a period
    // we only want one timer running and we need to be able to cancel it
    // so use a global var
    var globalTimer = null;
    var globalMessageShowTime = 3000;
    function message(text) {
        $("#message-box").html(text);
        if (globalTimer) {
            clearTimeout(globalTimer); //cancel the previous timer.
            globalTimer = null;
        }
        /*
        if(text != globalYourTurnMessage && globalMessageShowTime > 0) {
            globalTimer = setTimeout(function () {
                $("#message-box").html("&nbsp")
            }, globalMessageShowTime);
        }
        */
    }

    // generic function that will always call back false
    function returnFalseCallback(callback){
        callback(false);
    }
    // generic function that will always call back true
    function returnTrueCallback(callback){
        callback(true);
    }

    // discard a card from the player's hand to the discard pile
    var globalDiscardCardTime = 500;
    var globalHandSortTime = 100;

    // colour the box based on the card
    function colourBox(colour){
        $("#card-colour").removeClass();
        switch(colour){
            case "r":
                $("#card-colour").addClass("red box");
                break;
            case "g":
                $("#card-colour").addClass("green box");
                break;
            case "b":
                $("#card-colour").addClass("blue box");
                break;
            case "y":
                $("#card-colour").addClass("yellow box");
                break;
            default:
                $("#card-colour").addClass("black box");
                break;
        }
    }

    function discardCard(card, player, game, consequence, callback, uno, pickColour) {
        // force it to appear initially at the top of all cards
        $("#" + card.id).css("z-index", 2000);

        // empty the message
        message("");

        // main function to handle colour picker for black cards
        function cardColour(colour){
            console.log("discarding card " + card.id);
            // take the card out of the players hand
            var selectedCard = removeCard(player.hand, card.id);
            // and put the card on the top of the discard pile
            game.discard.unshift(card);

            card.colour = colour;
            colourBox(colour);

            // if the discarded card is a pick up card then add to the consequence
            // and reset the consequence
            if(card.consequence.pickUp > 0){
                console.log(player.div + " is adding to consequence");
                consequence.pickUp += selectedCard.consequence.pickUp;
                message("Pick up " + consequence.pickUp + "!");
            }

            // if the discarded card is a reverse then change direction
            // and reset the consequence
            if(card.consequence.reverse){
                console.log(player.div + " is changing direction");
                message("Change direction!");
                globalClockWise = !globalClockWise;
                consequence = clone(globalEmptyConsequence);
            }

            // if the discarded card is a skip then skip the next player
            // and reset the consequence
            if(card.consequence.skip){
                console.log(player.div + " is skipping the next player");
                message("Skip a go!");
                nextPlayerIndex = getNextPlayerIndex(game.players);
                consequence = clone(globalEmptyConsequence);
            }

            // layout the discard pile and the players hand
            layoutStack(game.discard, "#discard", true);
            layoutHand(player, player.hand, false);

            // animate the moves
            moveCards([card], globalDiscardCardTime, function () {
                moveCards(game.discard, 0, function () {
                    moveCards(player.hand, globalHandSortTime, function () {

                        function unoCallback(isUno){
                            if(isUno){
                                callback(card, player, game, consequence);
                            } else {
                                var pickUp2 = clone(globalEmptyConsequence);
                                pickUp2.pickUp = 2;
                                selectCardFromDeck(player, game, pickUp2, function(){
                                    callback(card, player, game, consequence);
                                }, returnFalseCallback)
                            }
                        }

                        // check if its the last card
                        // if so call uno
                        if(player.hand.length == 1) {
                            uno(unoCallback);
                        } else {
                            callback(card, player, game, consequence);
                        }
                    })
                })
            });
        }

        // black cards
        if(card.id[0] == "z") {
            var colour = pickColour(card, player, game, consequence, cardColour);
        } else {
            cardColour(card.colour);
        }
    }

    // select a card from the deck into the player's hand
    var globalSelectCardTime = 500;
    function selectCardFromDeck(player, game, consequence, callback, playCard, uno, pickColour) {
        // if we have a pick up consequence
        // call the select function multiple times and return;
        if(consequence.pickUp > 0){
            message("Picking up " + consequence.pickUp);
            for(var x = 0; x < consequence.pickUp - 1; x++){
                selectCardFromDeck(player, game, clone(globalEmptyConsequence), function(){}, returnFalseCallback)
            }
            selectCardFromDeck(player, game, clone(globalEmptyConsequence), callback, returnFalseCallback);
            return;
        }

        // take the card from the top of the deck
        var card = game.deck[0];
        // remove it from the deck
        var selectedCard = removeCard(game.deck, card.id);
        // and put the card into the players hand
        player.hand.unshift(selectedCard);

        // force it to appear initially at the top of all cards
        $("#" + selectedCard.id).css("z-index", 2000);

        // empty the message
        message("");

        // if deck is empty reset it with the discard pile
        if(game.deck.length == 0){
            var topCard = game.discard.shift();
            for(var i = 0; i < game.discard.length; i++) {
                game.deck.push(game.discard[i]);
                game.discard.splice(i, 1);
                i--; //decrement i if we remove an item
            }
            game.discard.push(topCard);
        }

        // layout the discard pile (from a reset), the players hand and the deck
        layoutStack(game.discard, "#discard", true);
        layoutStack(game.deck, "#deck", globalDeckFaceUp);
        layoutHand(player);

        // if the selected card can be played then make it highlighted
        if(isValidMove(selectedCard, game.discard[0], consequence)) {
            selectedCard.top -= globalHighlightOffset;
        }

        // animate the moves
        moveCards([selectedCard], globalSelectCardTime, function () {
            moveCards(game.discard, 0, function () {
                moveCards(game.deck, 0, function () {
                    moveCards(player.hand, globalHandSortTime, function () {

                        function playCardCallback(isPlay){
                            layoutHand(player);

                            if(isPlay){
                                discardCard(selectedCard, player, game, consequence, callback, uno, pickColour);
                            } else {
                                moveCards(player.hand, globalHandSortTime, function () {
                                    callback(selectedCard, player, game, clone(globalEmptyConsequence));
                                });
                            }
                        }

                        if(isValidMove(selectedCard, game.discard[0], consequence)){
                            playCard(playCardCallback);
                        } else {
                            callback(selectedCard, player, game, clone(globalEmptyConsequence));
                        }
                    })
                })
            })
        });
    }

    function setUpClickHandlers(game, consequence){
        console.log("setting up click handlers");
        $("#hint-button").show();
        $("#sort-button").show();
        $("#uno-button").show();

        var player = findPlayer(game.players, "bottom-player");

        // set-up select a deck card
        game.deck.forEach(function(card){
            $("#" + card.id).click(function(event){
                // check the card was in the deck
                // then force the card clicked to the top card in the deck
                var card = findCard(game.deck, event.currentTarget.id);
                if(card) {
                    handleDeckClickEvent(game.deck[0], player, game, consequence);
                }
            })
        });

        // set-up click a hand card
        // find this player
        player.hand.forEach(function(card){
            $("#" + card.id).click(function(event){
                // pass in the id of the selected card
                var card = findCard(player.hand, event.currentTarget.id);
                if(card) {
                    handleHandClickEvent(card, player, game, consequence);
                }
            })
        });

        // setup the function so that when the player clicks the hint button it provides a hint
        $("#hint-button").click(function () {
            hint(player, game, consequence);
        });
    }

    var globalDealCardsTime = 150;
    var globalDeckFaceUp = true;
    var globalDealOutNumber = 7;
    // deal out cards to the players from the deck move them into place and animate the move
    function dealOutCards(game) {
        // hide the deal and new game button once used
        $("#deal-button").hide();
        $("#reset-button").hide();

        // deal out the cards, returning the cards dealt out
        var cards = dealCards(game.deck, game.players, globalDealOutNumber);

        // set the first player
        globalPlayerIndex = game.players.length - 1;
        var player = game.players[globalPlayerIndex];

        // ask all of the players to layout their hands on the table
        game.players.forEach(function (player) {
            layoutHand(player);
        });

        // create a discard pile with the top card
        var card = game.deck.shift();
        // turn it face up
        card.faceup = true;
        game.discard.push(card);
        colourBox(card.colour);

        // layout the card in the discard pile
        layoutStack(game.discard, "#discard", true);

        // layout the cards in the deck
        layoutStack(game.deck, "#deck", globalDeckFaceUp);

        // animate the cards into place
        moveCards(cards, globalDealCardsTime, function () {
            moveCards(game.discard, globalDealCardsTime, function () {
                moveCards(game.deck, 0, function () {
                    // now show message box
                    $("#message-box").show();

                    // start the game
                    // set the player index to the end of the players list so that it starts at the first player next
                    $("#card-colour").show();
                    nextTurn(player, game, clone(globalEmptyConsequence))
                })
            })
        });
    }

    function calculateScore (cards){
        var total = 0;
        cards.forEach(function(card){
            total += card.score
        });
        return total
    }

    // this is the starting function for jQuery.
    // Its called when everything has initialised and the program can start
    $(document).ready(function () {

        // set-up all of the divs on the screen by calculating the screen size
        // this has to be done as mobile, tablet and PCs all have difference screen dimentions
        var width = $(window).width();
        var height = $(window).height();
        var minTable = 700;

        var maxTableWidth = Math.min(minTable, width);
        var maxTableHeight = Math.min(minTable, height);

        var cardWidth = 70;
        var cardHeight = 109;

        var smallCardWidth = cardWidth;
        var smallCardHeight = cardHeight;

        if (maxTableWidth < minTable) {
            smallCardWidth = 50;
            smallCardHeight = 78;
        }

        var tableHorizontalMiddle = width / 2;
        var tableVerticalMiddle = maxTableHeight / 2;

        // set the container with to the width of the table
        // this will align the heading in the table nicely
        $("#container").css("width", maxTableWidth);

        // set a spacing for all objects vertically
        var spacer = 10;
        // set a running top to just after the heading
        var runningTop = $("#uno-heading").outerHeight(true) + spacer;

        // work out the height of each object
        var buttonHeight = $("#deal-button").outerHeight(true);
        var boxHeight = $("#card-colour").outerHeight(true);
        var messageHeight = $("#message-box").outerHeight(true);

        $("#top-player").css("left", tableHorizontalMiddle + "px");
        $("#top-player").css("top", runningTop + "px");

        runningTop += smallCardHeight + spacer;

        $("#card-colour").css("left", tableHorizontalMiddle + cardWidth / 2 + "px");
        $("#card-colour").css("top", runningTop + "px");

        runningTop += boxHeight + spacer;

        $("#deck").css("left", tableHorizontalMiddle - cardWidth - 10 + "px");
        $("#deck").css("top", runningTop + "px");

        $("#discard").css("left", tableHorizontalMiddle + 10 + "px");
        $("#discard").css("top", runningTop + "px");

        $("#left-player").css("left", (tableHorizontalMiddle - maxTableWidth / 2) + smallCardWidth + "px");
        $("#left-player").css("top", runningTop + "px");

        $("#right-player").css("left", (tableHorizontalMiddle + maxTableWidth / 2) - smallCardWidth + "px");
        $("#right-player").css("top", runningTop + "px");

        runningTop += cardHeight / 2;

        $("#deal-button").css("left", tableHorizontalMiddle + 10 + "px");
        $("#deal-button").css("top", runningTop + "px");

        runningTop += cardHeight - cardHeight / 2 + spacer * 2;

        $("#reset-button").css("left", tableHorizontalMiddle - 50 + "px");
        $("#reset-button").css("top", runningTop + "px");

        runningTop += spacer;

        var boxLeft = tableHorizontalMiddle - 10;
        $("#red-box").css("left", boxLeft - cardWidth + 5 + "px");
        $("#red-box").css("top", runningTop + "px");
        $("#green-box").css("left", boxLeft - cardWidth / 2 + 10 + "px");
        $("#green-box").css("top", runningTop + "px");
        $("#blue-box").css("left", boxLeft + cardWidth / 2 - 10 + "px");
        $("#blue-box").css("top", runningTop + "px");
        $("#yellow-box").css("left", boxLeft + cardWidth - 5 + "px");
        $("#yellow-box").css("top", runningTop + "px");

        runningTop += buttonHeight;

        var messageWidth = Math.min(maxTableWidth, 300);
        var messageLeft = tableHorizontalMiddle - messageWidth / 2;

        $("#message-box").css("width", messageWidth + "px");
        $("#message-box").css("left", messageLeft + "px");
        $("#message-box").css("top", runningTop + "px");

        runningTop += messageHeight + spacer * 2;

        $("#bottom-player").css("left", tableHorizontalMiddle + "px");
        $("#bottom-player").css("top", runningTop + "px");

        runningTop += cardHeight + spacer;

        $("#hint-button").css("left", tableHorizontalMiddle - 110 + "px");
        $("#hint-button").css("top", runningTop + "px");

        $("#sort-button").css("left", tableHorizontalMiddle - 25 + "px");
        $("#sort-button").css("top", runningTop + "px");

        $("#uno-button").css("left", tableHorizontalMiddle + 60 + "px");
        $("#uno-button").css("top", runningTop + "px");

        globalBetweenMovesTime = 500;
        globalDiscardCardTime = 500;
        globalHandSortTime = 70;
        globalSelectCardTime = 500;
        globalDealCardsTime = 150;
        globalDealOutNumber = 7;
        globalDeckFaceUp = false;
        playersFaceUp = false;
        playersOffset = 10;

        // create the players array and creat some players
        var players = [];
        players.push({
            hand: [],
            name: "You",
            div: "bottom-player",
            offsetTop: 0,
            offsetLeft: 25,
            faceup: true,
            rotate:0,
            width: cardWidth,
            height: cardHeight,
            sort: false,
            score: 0,
            human: true
        });
        players.push({
            hand: [],
            name: "James",
            div: "left-player",
            offsetTop: playersOffset,
            offsetLeft: 0,
            faceup: playersFaceUp,
            rotate:90,
            width: smallCardWidth,
            height: smallCardHeight,
            sort: false,
            score: 0,
            human: false
        });
        players.push({
            hand: [],
            name: "Sam",
            div: "top-player",
            offsetTop: 0,
            offsetLeft: playersOffset,
            faceup: playersFaceUp,
            rotate:0,
            width: smallCardWidth,
            height: smallCardHeight,
            sort: false,
            score: 0,
            human: false
        });
        players.push({
            hand: [],
            name: "Emily",
            div: "right-player",
            offsetTop: playersOffset,
            offsetLeft: 0,
            faceup: playersFaceUp,
            rotate:-90,
            width: smallCardWidth,
            height: smallCardHeight,
            sort: false,
            score: 0,
            human: false
        });

        // create the discard and deck piles
        var discard = [];
        var deck = createDeck();
        var totalScore = calculateScore(deck);
        console.log("total score of the deck is " + totalScore);
        // put the cards initially in their own div area
        layoutCardsOnTable(deck, "#cards");
        // randomly shuffleCards the deck
        deck = shuffleCards(deck);
        //deck = sortCards(deck);
        // layout the cards into the deck
        layoutStack(deck, "#deck", false);
        // move them into the deck on the table
        moveCards(deck, 0, function () {});

        // show the deal button so it can be clicked
        $("#deal-button").show();

        // set up the game object
        var game = {players: players, deck: deck, discard: []};

        //dealOutCards(game);

        // setup the function so that when the player clicks the deal-button it deals out the cards
        $("#deal-button").click(function () {
            dealOutCards(game);
        });

        $("#reset-button").click(function () {
            game.deck = shuffleCards(createDeck());
            game.discard = [];
            game.players.forEach(function(player){
                player.hand = [];
            });

            // ask all of the players to layout their hands on the table
            game.players.forEach(function (player) {
                layoutHand(player);
            });

            // layout the card in the discard pile
            layoutStack(game.discard, "#discard", true);

            // layout the cards in the deck
            layoutStack(game.deck, "#deck", globalDeckFaceUp);

            // animate the cards into place
                moveCards(game.discard, globalDealCardsTime, function () {
                    moveCards(game.deck, 0, function () {
                        dealOutCards(game);
                    })
                });
        });

        // set-up the function so that when the play clicks the sort button their hand is sorted
        $("#sort-button").click(function () {
            var player = findPlayer(players, "bottom-player");
            player.sort = true;
            layoutHand(player);
            moveCards(player.hand, globalHandSortTime, function () {
            });
        });
    })

</script>
</body>
</html>